name: Generate Proposal Commentary
run-name: "Commentary for Proposal #${{ inputs.proposal_id }}"

on:
  workflow_dispatch:
    inputs:
      proposal_id:
        description: 'NNS Proposal ID to analyze'
        required: true
        type: string

jobs:
  commentary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Fetch forum cookies for Claude Code
        id: fetch-cookies
        env:
          COMMENTARY_SECRET: ${{ secrets.COMMENTARY_SECRET }}
          PORTAL_URL: ${{ secrets.PORTAL_URL }}
        run: |
          echo "Fetching forum cookies..."
          COOKIES=$(curl -s -H "Authorization: Bearer $COMMENTARY_SECRET" \
                         "$PORTAL_URL/api/forum-cookies" 2>/dev/null \
                         | jq -r '.cookies' 2>/dev/null || echo "")

          if [ -n "$COOKIES" ]; then
            # Mask the cookies aggressively (both full lines and individual values)
            echo "$COOKIES" | while IFS= read -r line; do
              if [ -n "$line" ]; then
                echo "::add-mask::$line"
                echo "$line" | grep -o '=[^;]*' | cut -c2- | while read val; do
                  [ -n "$val" ] && echo "::add-mask::$val"
                done
              fi
            done

            # Store in environment variable for Claude Code to use
            echo "FORUM_COOKIES<<EOF" >> $GITHUB_ENV
            echo "$COOKIES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV

            echo "cookies-available=true" >> $GITHUB_OUTPUT
            echo "✓ Cookies fetched and masked"
          else
            echo "FORUM_COOKIES=" >> $GITHUB_ENV
            echo "cookies-available=false" >> $GITHUB_OUTPUT
            echo "⚠️ No cookies available"
          fi

      - name: Generate commentary with Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Task: Analyze ICP Governance Proposal #${{ inputs.proposal_id }}

            You are generating AI commentary to help human reviewers understand this NNS governance proposal.

            ## Setup

            1. First, read the configuration files in this repository:
               - `config/commentary/prompt.md` - Detailed instructions for analysis
               - `config/commentary/rules.md` - Rules to follow when generating commentary
               - `config/commentary/schema.json` - The JSON schema your output must match

            2. Follow the step-by-step process described in `config/commentary/prompt.md`

            ## Your Task

            Analyze proposal ID: ${{ inputs.proposal_id }}

            Key steps:
            1. Run `npx tsx src/fetch-proposal.ts ${{ inputs.proposal_id }}` to fetch proposal data
            2. Read proposal.json to determine the source repository, then clone it to analyze the code diff
            3. Research context from GitHub PRs (using the correct repo from the proposal)
            4. Search DFINITY forum for discussion thread (see below)
            5. Generate structured commentary
            6. Include `repo_url` in your output JSON (the GitHub URL for the code being upgraded)

            ## Forum Search Instructions

            Authentication cookies for forum.dfinity.org are available in the FORUM_COOKIES environment variable.

            **CRITICAL SECURITY REQUIREMENTS:**
            - NEVER echo, print, or display the FORUM_COOKIES environment variable
            - ONLY use it with curl's --cookie flag: `curl --cookie "$FORUM_COOKIES"`
            - If you encounter errors, DO NOT include cookie values in error messages

            To search the forum as a research tool:

            1. Check if FORUM_COOKIES is set: `[ -n "$FORUM_COOKIES" ]`
            2. Use curl to fetch JSON (parse manually, DO NOT use jq):
               ```bash
               curl --cookie "$FORUM_COOKIES" -H "Accept: application/json" \
                    "https://forum.dfinity.org/search.json?q={proposal_id}" 2>/dev/null
               ```

            3. **Targeted search** - Find specific proposal discussion:
               - Search: GET https://forum.dfinity.org/search.json?q={proposal_id}
               - Thread: GET https://forum.dfinity.org/t/{slug}/{id}.json
               - Filter to NNS category (category_id: 76)
               - Verify proposal ID in first post

            4. **Contextual browsing** - Gather broader governance context:
               - NNS category: GET https://forum.dfinity.org/c/governance/nns-proposal-discussions/76.json
               - Look for related proposals, themes, and community discussions
               - This often provides valuable "why now" context for reviewers

            5. **Extract and cite context**:
               - Add all forum sources (threads and category browsing) to sources array
               - Use source type "forum_post"
               - Include context about related proposals or governance themes

            Note: Forum thread discovery and linking is handled separately by the portal.
            You do NOT need to post discovered threads - just use them for context in your analysis.

            If FORUM_COOKIES is empty or search fails, skip forum search (non-fatal).

            ## Output Requirements

            Your final output MUST be a valid JSON object matching the schema in `config/commentary/schema.json`.
            Output ONLY the JSON object - no markdown code fences, no explanatory text before or after.

            Remember: Accuracy is paramount. No commentary is better than fake or misleading commentary.
          claude_args: --dangerously-skip-permissions --max-turns 50
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORUM_COOKIES: ${{ env.FORUM_COOKIES }}

      - name: Format commentary output
        if: always()
        run: |
          OUTPUT_FILE="/home/runner/work/_temp/claude-execution-output.json"

          # Overwrite the summary completely (not append)
          if [ -f "$OUTPUT_FILE" ]; then
            npx tsx src/format-commentary.ts "$OUTPUT_FILE" > $GITHUB_STEP_SUMMARY 2>&1 || {
              echo "## ⚠️ Formatting Failed" > $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Check the workflow logs for Claude's output." >> $GITHUB_STEP_SUMMARY
            }
          else
            echo "## ❌ Error" > $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Claude execution file not found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post commentary to reviewer portal
        if: success()
        env:
          COMMENTARY_SECRET: ${{ secrets.COMMENTARY_SECRET }}
          PORTAL_URL: ${{ secrets.PORTAL_URL }}
        run: |
          OUTPUT_FILE="/home/runner/work/_temp/claude-execution-output.json"

          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "⚠️ Claude execution file not found, skipping portal post"
            exit 0
          fi

          if [ -z "$COMMENTARY_SECRET" ]; then
            echo "⚠️ COMMENTARY_SECRET not configured, skipping portal post"
            exit 0
          fi

          if [ -z "$PORTAL_URL" ]; then
            echo "⚠️ PORTAL_URL not configured, skipping portal post"
            exit 0
          fi

          npx tsx src/post-commentary.ts "$OUTPUT_FILE" "${{ inputs.proposal_id }}" || {
            echo "⚠️ Failed to post commentary to portal (non-fatal)"
            exit 0
          }
